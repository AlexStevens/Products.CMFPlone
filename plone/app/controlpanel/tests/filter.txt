Filter control panel
====================

First some initial setup code:

    >>> import sys
    >>> browser = self.browser
    >>> safe_html = self.getToolByName('portal_transforms').safe_html
    >>> kupu_tool = self.getToolByName('kupu_library_tool')
    >>> self.loginAsManager()

Viewing the search control panel
--------------------------------

    >>> browser.open('http://nohost/plone/@@filter-controlpanel.html')
    >>> browser.url.endswith('filter-controlpanel.html')
    True

Click the save button without making any changes:

    >>> browser.getControl(name="form.actions.save").click()
    >>> browser.url.endswith('filter-controlpanel.html')
    True

We should get a status message:

    >>> 'Changes saved.' in browser.contents
    True

Now click the cancel button:

    >>> browser.getControl(name="form.actions.cancel").click()
    >>> browser.url.endswith('plone_control_panel')
    True

There should be still no changes:

    >>> 'Changes canceled.' in browser.contents
    True

Look at the defaults
--------------------

    >>> browser.open('http://nohost/plone/@@filter-controlpanel.html')

    >>> def print_all_of(fieldname):
    ...     for i in xrange(sys.maxint):
    ...         key = 'form.%s.%s.' % (fieldname, i)
    ...         try:
    ...             print browser.getControl(name=key).value
    ...         except LookupError, e:
    ...             break

    >>> print_all_of('nasty_tags')
    applet
    embed
    object
    script

    >>> print_all_of('stripped_tags')
    abbr
    acronym
    address
    bdo
    button
    col
    colgroup
    dfn
    fieldset
    form
    input
    label
    legend
    link
    noscript
    object
    optgroup
    option
    param
    samp
    script
    select
    style
    textarea
    tfoot
    thead
    var

    >>> print_all_of('custom_tags')
    u

    # XXX Hello Duncan!
    >>> print_all_of('stripped_attributes')
    >>> print_all_of('stripped_combinations')
    >>> print_all_of('style_whitelist')
    >>> print_all_of('class_whitelist')

Changing some values
--------------------

Add a new nasty tag

    >>> browser.getControl("Add Nasty tags").click()
    >>> browser.getControl(name="form.nasty_tags.4.").value = "span"
    >>> browser.getControl(name="form.actions.save").click()
    >>> print_all_of('nasty_tags')
    applet
    embed
    object
    script
    span
    >>> print sorted(safe_html._config['nasty_tags'])
    [u'applet', u'embed', u'object', u'script', u'span']

Adding span to nasty tags should have automatically removed it from the valid tags.

Check that the filtering works
------------------------------

    >>> browser.getLink('My Folder').click()
    >>> browser.getLink('Add to folder').click()
    >>> 'Add new item' in browser.contents
    True
    >>> browser.getControl('Add Page').click()
    >>> browser.getControl('Body Text').value = \
    ... '<p>Testing that<span> tag and its contents get stripped</span> works.</p>'
    >>> browser.getControl('Title').value = 'My Page'
    >>> browser.getControl('Save').click()
    >>> 'Changes saved.' in browser.contents
    True
    >>> 'My Page' in browser.contents
    True
    >>> '<p>Testing that works.</p>' in browser.contents
    True
